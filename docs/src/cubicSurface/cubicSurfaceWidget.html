<!-- KaTeX einbinden -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" />
<script defer="defer" src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.css" />
<script defer="defer" src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js"></script> <!-- Bootstrap (optional, wie gehabt) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<div class="container my-4">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-3">
                Cubic Surfaces
            </h3>
        </div>
        <!-- Controls -->

        <div class="col-12">
            <div class="p-3 bg-white rounded shadow-sm mb-3">
                <div class="row g-3 align-items-end">
                    <div class="col-12 col-md-3">
                        <label class="form-label mb-1">Surface</label> <select id="surfaceMode" class="form-select form-select-sm">
                            <option value="sphere">
                                Sphere
                            </option>
                            <option value="clebsch">
                                Clebsch
                            </option>
                            <option value="cayley">
                                Cayley-Kubik
                            </option>
                            <option value="monkeySaddle">
                                Monkey Saddle
                            </option>
                            <option value="cylinder">
                                Cylinder
                            </option>
                            <option value="crosspropeller">
                                Crosspropeller
                            </option>
                            <option value="custom">
                                Custom
                            </option>
                        </select>
                    </div>

                    <div class="col-12 col-md-3">
                        <label class="form-label mb-1">View</label> <select id="viewMode" class="form-select form-select-sm">
                            <option value="1">
                                Perspective
                            </option>
                            <option value="2">
                                Orthographic
                            </option>
                            <option value="3">
                                Stereo (Rot/Cyan)
                            </option>
                        </select>
                    </div>

                    <div class="col-12 col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="showAxes" checked="checked" /> <label class="form-check-label" for="showAxes">show Axes</label>
                        </div>
                    </div>

                    <div class="col-12 col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="showBox" checked="checked" /> <label class="form-check-label" for="showBox">show Volumecube</label>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Sliders -->

            <div id="sliderContainer" class="p-3 bg-white rounded shadow-sm mb-3">
            </div>
            <!-- Formel -->

            <div id="formulaBox" class="p-3 bg-white rounded shadow-sm mb-3">
                <div id="formulaText" style="width:100%; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; font-size: 14px; line-height: 1.4;">
                    F(x,y,z) = 0
                </div>
            </div>
        </div>
        <!-- Renderer -->

        <div class="col-12">
            <div class="ratio ratio-16x9">
                <iframe id="cubicFrame" class="w-100 h-100 border-0" allowfullscreen="allowfullscreen" name="cubicFrame"></iframe>
            </div>
        </div>
    </div>
</div>
<script>
/* <![CDATA[ */
// === Render-Seite ===
const cubicUrl = "https://yannick168.github.io/Bachelorarbeit/src/cubicSurface/cubicSurface.html";

/* Monomiale (ASCII/TeX-Keys) */
const monomials = [
  "x^3","y^3","z^3",
  "x^2y","x^2z","y^2z","yz^2","xy^2","xz^2","xyz",
  "x^2","y^2","z^2",
  "xz","xy","yz",
  "x","y","z",
  "1"
];

const rows = [
  ["x^3","y^3","z^3","x^2y","x^2z","y^2z","yz^2","xy^2","xz^2","xyz"],
  ["x^2","y^2","z^2","xz","xy","yz"],
  ["x","y","z"],
  ["1"]
];

/* Defaults: Kugel x^2 + y^2 + z^2 − 1 = 0 */
const defaults = {
  "x^3":0,"y^3":0,"z^3":0,
  "x^2y":0,"x^2z":0,"y^2z":0,"yz^2":0,"xy^2":0,"xz^2":0,"xyz":0,
  "x^2":1,"y^2":1,"z^2":1,
  "xz":0,"xy":0,"yz":0,
  "x":0,"y":0,"z":0,
  "1":-1
};

/* Presets in derselben Reihenfolge wie monomials */
const PRESETS = {
  sphere:         [0,0,0,  0,0,0,0,0,0,0,  1,1,1,  0,0,0,  0,0,0,  -1],
  clebsch:        [81,81,81,  -189,-189,-189,-189,-189,-189, 54,  -9,-9,-9,  126,126,126,  -9,-9,-9,  1],
  cayley:         [0,0,0,  0,0,0,0,0,0,1,  0,0,0,  0,0,0,  0,1,1,  1],
  monkeySaddle:   [1,0,0,  0,0,0,0,-3,0,0,  0,0,0,  0,0,0,  0,0,-1,  0],
  cylinder:       [0,0,0,  0,0,0,0,0,0,0,  1,1,0,  0,0,0,  0,0,0,  -1],
  crosspropeller: [0,0,0,  0,0,0,0,0,0,1,  1,0.1,0,  0,0,0,  0,0,0,  0],
  custom:         [0,0,0,  0,0,0,0,0,0,0,  0,0,0,  0,0,0,  0,0,0,  0]
};

/* States */
const inputs = [];
const sliders = [];

/* Styles */
const ROW_STYLE   = "display:flex;flex-wrap:wrap;justify-content:flex-start;gap:4px;margin-bottom:6px;padding-bottom:8px;";
const CELL_STYLE  = "flex:0 0 9%;max-width:9%;display:flex;flex-direction:column;align-items:center;";
const LABEL_STYLE = "font-size:10px;font-weight:600;text-align:center;margin-bottom:2px;line-height:1.1;";
const RANGE_STYLE = "width:100%;height:12px;padding:0;margin:0 0 2px 0;";
const NUM_STYLE   = "width:100%;height:20px;font-size:11px;text-align:center;padding:1px;";

/* KaTeX: Monomial-Key -> LaTeX-Body (keine Delimiter) */
const latexMono = {
  "x^3":"x^{3}","y^3":"y^{3}","z^3":"z^{3}",
  "x^2y":"x^{2}y","x^2z":"x^{2}z","y^2z":"y^{2}z","yz^2":"y z^{2}",
  "xy^2":"x y^{2}","xz^2":"x z^{2}","xyz":"x y z",
  "x^2":"x^{2}","y^2":"y^{2}","z^2":"z^{2}",
  "xz":"x z","xy":"x y","yz":"y z",
  "x":"x","y":"y","z":"z","1":"1"
};

/* Parsing/Format */
function parseNum(s){
  if (typeof s !== 'string') s = String(s ?? '');
  return parseFloat(s.replace(',', '.'));
}
const NEAR_ZERO = 1e-9;
const isZero = (n)=>Math.abs(n) < NEAR_ZERO;
function niceNumber(n){
  let s = Number(n).toFixed(3).replace(/\.?0+$/,'');
  if (s === '-0') s = '0';
  return s;
}

/* Einzelterm -> TeX */
function termToTeX(coeff, monoKey){
  const abs = Math.abs(coeff);
  if (monoKey === "1") return niceNumber(abs);
  const mono = latexMono[monoKey] || monoKey;
  if (Math.abs(abs - 1) < NEAR_ZERO) return mono; // 1·x -> x
  return `${niceNumber(abs)}\\,${mono}`;
}

/* Zeilenbreite */
function termsPerLineForWidth(px){
  if (px < 420) return 6;
  if (px < 640) return 8;
  if (px < 900) return 10;
  if (px < 1200) return 12;
  return 14;
}

/* Formel-TeX mit aligned und weichen Zeilenumbrüchen */
function buildFormulaTeXWrapped(coeffs, termsPerLine){
  const parts = [];
  monomials.forEach((m,i) => {
    const c = Number(coeffs[i] ?? 0);
    if (isZero(c)) return;
    parts.push({ sign: c<0 ? "-" : "+", body: termToTeX(c, m) });
  });
  if (parts.length === 0) return `F(x,y,z)=0`;

  const lines = [];
  let line = `F(x,y,z) &= `;
  let count = 0;

  line += (parts[0].sign === "+") ? `${parts[0].body}` : `- ${parts[0].body}`;
  count = 1;

  for (let k=1; k<parts.length; k++){
    if (count >= termsPerLine){
      lines.push(line);
      line = `&\\quad `;
      count = 0;
    }
    line += (parts[k].sign === "+") ? ` + ${parts[k].body}` : ` - ${parts[k].body}`;
    count++;
  }
  line += ` = 0`;
  lines.push(line);

  return `\\begin{aligned} ${lines.join(' \\\\ ')} \\end{aligned}`;
}

/* Slider-Label via KaTeX (ohne Klammern/Delimiter) */
function monoLabelHTML(monoKey){
  const tex = latexMono[monoKey] || monoKey;
  return katex.renderToString(tex, { displayMode: false, throwOnError: false });
}

/* UI */
function createSlider(mono){
  const base = Number(defaults[mono] ?? 0);
  const wrap = document.createElement("div");
  wrap.setAttribute("style", CELL_STYLE);

  const lab = document.createElement("div");
  lab.setAttribute("style", LABEL_STYLE);
  lab.innerHTML = monoLabelHTML(mono); // keine \( \), keine Klammern sichtbar

  const num = document.createElement("input");
  num.type = "number"; num.setAttribute('lang','de');
  num.className = "form-control form-control-sm";
  num.setAttribute("style", NUM_STYLE);
  num.step = "0.1"; num.value = String(base);

  const rng = document.createElement("input");
  rng.type = "range"; rng.className = "form-range";
  rng.setAttribute("style", RANGE_STYLE);
  rng.step = "0.1"; rng.min = (base - 5).toString(); rng.max = (base + 5).toString(); rng.value = String(base);

  const listId = "ticks-" + mono;
  rng.setAttribute("list", listId);
  const datalist = document.createElement("datalist"); datalist.id = listId;
  [rng.min, 0, rng.max].forEach(v => { const opt = document.createElement("option"); opt.value = v; datalist.appendChild(opt); });

  rng.addEventListener("input", () => { num.value = rng.value; sendAll(); updateFormula(); });
  num.addEventListener("input", () => {
    const v = parseNum(num.value);
    if (isFinite(v)) {
      rng.min = (v - 5).toFixed(1); rng.max = (v + 5).toFixed(1); rng.value = String(v);
      datalist.innerHTML = ""; [rng.min, 0, rng.max].forEach(val => { const opt = document.createElement("option"); opt.value = val; datalist.appendChild(opt); });
      sendAll(); updateFormula();
    }
  });

  wrap.appendChild(lab);
  wrap.appendChild(num);
  wrap.appendChild(rng);
  wrap.appendChild(datalist);

  const idx = monomials.indexOf(mono);
  inputs[idx] = num; sliders[idx] = rng;
  return wrap;
}

function buildSliders(){
  const container = document.getElementById("sliderContainer");
  container.innerHTML = "";
  rows.forEach(rowList => {
    const row = document.createElement("div"); row.setAttribute("style", ROW_STYLE);
    rowList.forEach(m => row.appendChild(createSlider(m)));
    container.appendChild(row);
  });
}

function currentCoeffs(){
  return monomials.map((m, i) => {
    const v = parseNum(inputs[i]?.value);
    return isFinite(v) ? v : 0;
  });
}

/* ==== Formel rendern: KaTeX in DOM (copy-tex aktiv) ==== */
function updateFormula(){
  const coeffs = currentCoeffs();
  const box = document.getElementById("formulaBox");
  const tpl = termsPerLineForWidth(box.clientWidth);
  const tex = buildFormulaTeXWrapped(coeffs, tpl); // LaTeX-String

  const out = document.getElementById("formulaText");
  // displayMode -> Blockformel; copy-tex sorgt beim Kopieren für LaTeX-Quelltext
  katex.render(tex, out, { displayMode: true, throwOnError: false });
}

/* Messaging */
function sendAll(){
  const frame = document.getElementById("cubicFrame");
  if (!frame || !frame.contentWindow) return;

  const coeffs = currentCoeffs();
  frame.contentWindow.postMessage({ type: "coeffs", coeffs }, "*");

  const viewMode  = parseInt(document.getElementById("viewMode").value, 10);
  const showBox   = document.getElementById("showBox").checked;
  const showAxes  = document.getElementById("showAxes").checked;
  const surfaceKey = document.getElementById("surfaceMode").value; // <— NEU

  frame.contentWindow.postMessage({
    type: "controls",
    viewMode,
    showBox,
    showAxes,
    surfaceMode: surfaceKey   // <— NEU
  }, "*");
}



function resetSlidersToCenter(span = 5){
  for (let i = 0; i < monomials.length; i++) {
    const v = parseNum(inputs[i].value) || 0;
    sliders[i].min = (v - span).toFixed(1);
    sliders[i].max = (v + span).toFixed(1);
    sliders[i].value = String(v);
    const listId = "ticks-" + monomials[i];
    const dl = sliders[i].list || document.getElementById(listId);
    if (dl) {
      dl.innerHTML = "";
      [sliders[i].min, 0, sliders[i].max].forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        dl.appendChild(opt);
      });
    }
  }
}

function applyPreset(key){
  const coeffs = PRESETS[key];
  if (!Array.isArray(coeffs)) return;
  for (let i = 0; i < monomials.length; i++){
    const v = Number(coeffs[i] ?? 0);
    inputs[i].value = String(v);
  }
  resetSlidersToCenter(5);
}

/* Init (nachdem KaTeX geladen ist) */
function initApp(){
  const frame = document.getElementById("cubicFrame");
  frame.src = cubicUrl + (cubicUrl.includes("?") ? "&" : "?") + "v=" + Date.now();

  buildSliders();
  applyPreset(document.getElementById("surfaceMode").value);
  sendAll();
  updateFormula();

  document.getElementById("viewMode").addEventListener("change", sendAll);
  document.getElementById("surfaceMode").addEventListener("change", (e) => {
    applyPreset(e.target.value);
    sendAll();
    updateFormula();
  });
  document.getElementById("showAxes").addEventListener("change", sendAll); // <— NEU
  document.getElementById("showBox").addEventListener("change", sendAll);

  frame.addEventListener("load", () => setTimeout(() => { sendAll(); updateFormula(); }, 150));

  let _t;
  window.addEventListener('resize', () => {
    clearTimeout(_t);
    _t = setTimeout(updateFormula, 150);
  });
}

/* Warten bis KaTeX verfügbar ist (defer kann asynchron laden) */
(function waitForKatex(){
  if (window.katex && typeof katex.render === "function") {
    initApp();
  } else {
    setTimeout(waitForKatex, 50);
  }
})();
/* ]]> */
</script>